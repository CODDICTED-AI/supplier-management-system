# 农福尚汇客户管理系统 - 完整部署指南

## 📋 部署概览

本系统采用现代化的云部署架构：
- **前端**: Vercel (React + TypeScript)
- **后端**: Render (Node.js + Express + TypeScript)  
- **数据库**: Supabase (PostgreSQL)
- **文件存储**: 本地存储 (Render 服务器)

## 🚀 第一步：准备 GitHub 仓库

### 1.1 确保代码已推送到 GitHub
```bash
# 检查当前状态
git status

# 如果有未提交的更改，先提交
git add .
git commit -m "完成系统优化，准备部署"

# 推送到 GitHub
git push origin main
```

### 1.2 验证仓库结构
确保您的 GitHub 仓库包含以下目录结构：
```
supplier-management-system/
├── frontend/          # React 前端
├── backend/           # Node.js 后端
├── README.md
├── vercel.json        # Vercel 配置
└── .gitignore
```

## 🗄️ 第二步：设置 Supabase 数据库

### 2.1 创建 Supabase 项目
1. 访问 [https://supabase.com](https://supabase.com)
2. 使用 GitHub 账号登录
3. 点击 "New Project"
4. 填写项目信息：
   - **Organization**: 选择您的组织
   - **Name**: `supplier-management-db`
   - **Database Password**: 设置一个强密码（请记住）
   - **Region**: 选择离您最近的区域（推荐 `ap-northeast-1`）

### 2.2 获取数据库连接信息
1. 项目创建完成后，进入项目仪表板
2. 点击左侧菜单 "Settings" → "Database"
3. 记录以下信息：
   - **Host**: `db.xxxxxxxxxxxxx.supabase.co`
   - **Database name**: `postgres`
   - **Port**: `5432`
   - **User**: `postgres`
   - **Password**: 您设置的密码

### 2.3 创建数据库表
1. 点击左侧菜单 "SQL Editor"
2. 点击 "New query"
3. 复制并粘贴以下 SQL 代码：

```sql
-- PostgreSQL 数据库初始化脚本
-- 适用于 Supabase

-- 1. 供应商表 (suppliers)
CREATE TABLE IF NOT EXISTS suppliers (
  id SERIAL PRIMARY KEY,
  company_name VARCHAR(255) NOT NULL UNIQUE,
  contact_person VARCHAR(100) NOT NULL,
  contract_start_date DATE,
  contract_end_date DATE,
  logistics_type VARCHAR(10) DEFAULT '随货' CHECK (logistics_type IN ('随货', '独立')),
  contract_file_path VARCHAR(500),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. 供应商产品表 (supplier_products)
CREATE TABLE IF NOT EXISTS supplier_products (
  id SERIAL PRIMARY KEY,
  supplier_id INTEGER NOT NULL,
  product_name VARCHAR(255) NOT NULL,
  supply_price DECIMAL(10,2) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (supplier_id) REFERENCES suppliers(id) ON DELETE CASCADE
);

-- 3. 订单表 (orders)
CREATE TABLE IF NOT EXISTS orders (
  id SERIAL PRIMARY KEY,
  supplier_id INTEGER NOT NULL,
  order_contact VARCHAR(100) NOT NULL,
  product_name VARCHAR(255) NOT NULL,
  order_date DATE NOT NULL,
  unit_price DECIMAL(10,2) NOT NULL,
  quantity INTEGER NOT NULL,
  total_amount DECIMAL(10,2) GENERATED ALWAYS AS (unit_price * quantity) STORED,
  expected_delivery_date DATE,
  status VARCHAR(10) DEFAULT '未完成' CHECK (status IN ('未完成', '已完成')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (supplier_id) REFERENCES suppliers(id)
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_suppliers_company_name ON suppliers(company_name);
CREATE INDEX IF NOT EXISTS idx_orders_supplier_id ON orders(supplier_id);
CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
CREATE INDEX IF NOT EXISTS idx_orders_order_date ON orders(order_date);

-- 创建更新时间触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_suppliers_updated_at BEFORE UPDATE ON suppliers
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_orders_updated_at BEFORE UPDATE ON orders
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

4. 点击 "Run" 执行 SQL 脚本
5. 验证表创建成功（左侧菜单 "Table Editor" 中应该能看到三个表）

## ⚙️ 第三步：部署后端到 Render

### 3.1 创建 Render 账号
1. 访问 [https://render.com](https://render.com)
2. 使用 GitHub 账号登录

### 3.2 创建 Web Service
1. 点击 "New +" → "Web Service"
2. 连接您的 GitHub 仓库
3. 选择 `supplier-management-system` 仓库

### 3.3 配置服务
填写以下配置信息：

**基本信息：**
- **Name**: `supplier-management-backend`
- **Root Directory**: `backend`
- **Runtime**: `Node`
- **Build Command**: `npm install && npm run build`
- **Start Command**: `npm start`
- **Plan**: 选择 "Free"

**环境变量：**
点击 "Environment Variables" 部分，添加以下变量：

```
DB_HOST=db.xxxxxxxxxxxxx.supabase.co
DB_USER=postgres
DB_PASSWORD=您的Supabase数据库密码
DB_NAME=postgres
DB_PORT=5432
DB_SSL=true
PORT=3001
NODE_ENV=production
UPLOAD_PATH=./uploads
```

**重要提示：**
- 将 `db.xxxxxxxxxxxxx.supabase.co` 替换为您的实际 Supabase 主机地址
- 将 `您的Supabase数据库密码` 替换为您在 Supabase 中设置的实际密码

### 3.4 创建服务
1. 点击 "Create Web Service"
2. 等待部署完成（通常需要 2-5 分钟）
3. 部署成功后，记录生成的 URL（例如：`https://supplier-management-backend.onrender.com`）

### 3.5 验证后端部署
1. 在浏览器中访问：`https://supplier-management-backend.onrender.com/api/health`
2. 应该看到类似以下的响应：
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## 🎨 第四步：部署前端到 Vercel

### 4.1 创建 Vercel 账号
1. 访问 [https://vercel.com](https://vercel.com)
2. 使用 GitHub 账号登录

### 4.2 导入项目
1. 点击 "New Project"
2. 选择您的 GitHub 仓库 `supplier-management-system`
3. 配置项目：
   - **Framework Preset**: 选择 "Other"
   - **Root Directory**: `frontend`
   - **Build Command**: `npm run build`
   - **Output Directory**: `build`
   - **Install Command**: `npm install`

### 4.3 配置环境变量
在 "Environment Variables" 部分添加：

```
REACT_APP_API_URL=https://supplier-management-backend.onrender.com/api
```

**重要：** 将 URL 替换为您实际的 Render 后端 URL

### 4.4 部署项目
1. 点击 "Deploy"
2. 等待部署完成（通常需要 1-3 分钟）
3. 部署成功后，记录生成的 URL（例如：`https://supplier-management-system.vercel.app`）

## 🔧 第五步：测试系统

### 5.1 功能测试
1. 访问您的前端 URL
2. 测试以下功能：
   - ✅ 供应商管理：添加、编辑、删除供应商
   - ✅ 订单管理：创建、查看、完成订单
   - ✅ 文件上传：上传 PDF 合同文件
   - ✅ 搜索功能：按公司名称或产品名称搜索
   - ✅ 分页功能：订单列表分页显示

### 5.2 数据库验证
1. 在 Supabase 仪表板中查看 "Table Editor"
2. 确认数据正确保存到数据库中

## 📱 第六步：分享给其他用户

### 6.1 获取访问链接
- **前端地址**: `https://your-project-name.vercel.app`
- **后端地址**: `https://your-backend-name.onrender.com`

### 6.2 用户访问
其他用户只需要前端地址即可使用系统，无需安装任何软件。

## 🔒 第七步：安全配置（可选）

### 7.1 设置自定义域名
如果您有自己的域名，可以在 Vercel 和 Render 中配置自定义域名。

### 7.2 数据库安全
1. 在 Supabase 中设置 Row Level Security (RLS)
2. 配置数据库访问策略

## 🚨 故障排除

### 常见问题及解决方案

#### 1. 后端部署失败
**问题**: Build 失败或启动失败
**解决方案**:
- 检查环境变量是否正确设置
- 确认 Supabase 数据库连接信息正确
- 查看 Render 日志获取详细错误信息

#### 2. 前端无法连接后端
**问题**: 前端显示连接错误
**解决方案**:
- 确认 `REACT_APP_API_URL` 环境变量设置正确
- 检查后端服务是否正常运行
- 验证 CORS 配置

#### 3. 数据库连接失败
**问题**: 后端无法连接数据库
**解决方案**:
- 检查 Supabase 连接信息
- 确认数据库表已正确创建
- 验证网络连接

#### 4. 文件上传失败
**问题**: 无法上传 PDF 文件
**解决方案**:
- 确认文件大小不超过 5MB
- 检查文件格式是否为 PDF
- 验证服务器存储权限

## 📞 技术支持

如果在部署过程中遇到问题：

1. **查看日志**:
   - Render 后端日志：在 Render 仪表板中查看
   - Vercel 前端日志：在 Vercel 仪表板中查看

2. **检查状态**:
   - 后端健康检查：`https://your-backend-url/api/health`
   - 前端状态：直接访问前端 URL

3. **常见错误代码**:
   - `ECONNREFUSED`: 数据库连接失败
   - `ENOTFOUND`: 主机名解析失败
   - `ETIMEDOUT`: 连接超时

## 🎉 部署完成

恭喜！您的农福尚汇客户管理系统已经成功部署到云端。系统现在可以：

- ✅ 支持多用户同时访问
- ✅ 数据安全存储在云端
- ✅ 自动备份和恢复
- ✅ 高可用性和稳定性
- ✅ 随时随地进行管理

**系统地址**: `https://your-project-name.vercel.app`

现在您可以将这个链接分享给需要使用的用户，他们就可以通过浏览器访问您的客户管理系统了！ 